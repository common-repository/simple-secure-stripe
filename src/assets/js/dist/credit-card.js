!function(t,e){function i(){this.elementStatus={},e.BaseGateway.call(this,sswps_credit_card_params),e.CheckoutGateway.call(this),this.message_container=this.params.notice_selector,window.addEventListener("hashchange",this.hashchange.bind(this)),e.credit_card=this,this.confirmedSetupIntent=!1,this.has3DSecureParams(),this.handle_create_account_change(),t(document.body).on("change",'[name="sswps_cc_saved_method_key"]',this.maybe_initialize_installments.bind(this)),t(document.body).on("sswps_saved_method_"+this.gateway_id,this.maybe_initialize_installments.bind(this)),t(document.body).on("change",'[name="billing_email"], [name="billing_phone"]',this.handle_email_change.bind(this))}var s={focus:"focused",empty:"empty",invalid:"invalid"};i.prototype=t.extend({},e.BaseGateway.prototype,e.CheckoutGateway.prototype),i.prototype.mappings={cardNumber:"#stripe-card-number",cardExpiry:"#stripe-exp",cardCvc:"#stripe-cvv"},i.prototype.handleActionMethod="handleCardAction",i.prototype.setupActionMethod="confirmCardSetup",i.prototype.initialize=function(){t(document.body).on("click","#place_order",this.place_order.bind(this)),t(document.body).on("change","#createaccount",this.handle_create_account_change.bind(this)),this.setup_card(),this.has_gateway_data()&&this.can_create_setup_intent()&&this.create_setup_intent(),this.maybe_initialize_installments()},i.prototype.setup_card=function(){if(this.is_custom_form()){var e=t.extend(!0,{classes:s},this.params.cardOptions);["cardNumber","cardExpiry","cardCvc"].forEach(function(i){this[i]=this.elements.create(i,t.extend(!0,{},e,this.params.customFieldOptions[i])),this.elementStatus[i]={},this[i].on("change",this.on_card_element_change.bind(this))}.bind(this)),this.cardNumber.on("change",this.card_number_change.bind(this)),this.cardNumber.on("change",this.on_input_change.bind(this)),this.cardExpiry.on("change",this.on_input_change.bind(this)),this.cardCvc.on("change",this.on_input_change.bind(this)),this.fields.required("billing_postcode")&&""!==this.fields.get("billing_postcode")&&t("#stripe-postal-code").length>0&&(t("#stripe-postal-code").val(this.fields.get("billing_postcode")),this.validate_postal_field()),t(document.body).on("change","#billing_postcode",function(e){var i=t("#billing_postcode").val();t("#stripe-postal-code").val(i).trigger("keyup")}.bind(this))}else this.is_payment_element_enabled()?(this.card=this.elements.create("payment",{fields:{billingDetails:this.is_current_page("checkout")?{address:"never"}:"auto"},wallets:{applePay:"never",googlePay:"never"},defaultValues:{billingDetails:{email:this.fields.get("billing_email"),phone:this.fields.get("billing_phone")}}}),this.elementStatus.payment={}):(this.card=this.elements.create("card",t.extend(!0,{},{value:{postalCode:this.fields.get("billing_postcode","")},hidePostalCode:this.fields.required("billing_postcode"),iconStyle:"default"},this.params.cardOptions)),t(document.body).on("change","#billing_postcode",function(e){this.card&&this.card.update({value:t("#billing_postcode").val()})}.bind(this)),this.elementStatus.card={}),this.card.on("change",this.on_card_element_change.bind(this));setInterval(this.create_card_element.bind(this),2e3)},i.prototype.validate_postal_field=function(){if(t("#billing_postcode").length&&t("#stripe-postal-code").length)if(this.params.postal_regex[this.fields.get("billing_country")]){var e=this.params.postal_regex[this.fields.get("billing_country")],i=t("#stripe-postal-code").val(),s=new RegExp(e,"i");""!==i?null!==s.exec(i)?t("#stripe-postal-code").addClass("StripeElement--complete").removeClass("invalid"):t("#stripe-postal-code").removeClass("StripeElement--complete").addClass("invalid"):t("#stripe-postal-code").removeClass("StripeElement--complete").removeClass("invalid")}else 0!=t("#stripe-postal-code").val()?t("#stripe-postal-code").addClass("StripeElement--complete"):t("#stripe-postal-code").removeClass("StripeElement--complete");else t("#stripe-postal-code").length&&(""!=t("#stripe-postal-code").val()?t("#stripe-postal-code").addClass("StripeElement--complete"):t("#stripe-postal-code").removeClass("StripeElement--complete"))},i.prototype.create_card_element=function(){this.is_custom_form()?t("#sswps-cc-custom-form").length&&0==t("#sswps-cc-custom-form").find("iframe").length&&(t(this.mappings.cardNumber).length&&(this.cardNumber.mount(this.mappings.cardNumber),t(this.mappings.cardNumber).prepend(this.params.html.card_brand)),t(this.mappings.cardExpiry).length&&this.cardExpiry.mount(this.mappings.cardExpiry),t(this.mappings.cardCvc).length&&this.cardCvc.mount(this.mappings.cardCvc),t("#stripe-postal-code").length&&(t("#stripe-postal-code, .postalCode").on("focus",function(e){t("#stripe-postal-code").addClass("focused")}.bind(this)),t("#stripe-postal-code, .postalCode").on("blur",function(e){t("#stripe-postal-code").removeClass("focused").trigger("keyup")}.bind(this)),t("#stripe-postal-code").on("keyup",function(e){0==t("#stripe-postal-code").val()?t("#stripe-postal-code").addClass("empty"):t("#stripe-postal-code").removeClass("empty")}.bind(this)),t("#stripe-postal-code").on("change",this.validate_postal_field.bind(this)),t("#stripe-postal-code").trigger("change"))):t("#sswps-card-element").length&&0==t("#sswps-card-element").find("iframe").length&&(this.card.unmount(),this.card.mount("#sswps-card-element"),this.is_payment_element_enabled()||this.card.update({value:{postalCode:this.fields.get("billing_postcode","")},hidePostalCode:this.fields.required("billing_postcode")})),t(this.container).outerWidth(!0)<450?t(this.container).addClass("stripe-small-container"):t(this.container).removeClass("stripe-small-container")},i.prototype.place_order=function(e){if(this.is_gateway_selected())if(this.fields.syncCheckoutFieldsWithDOM(),this.can_create_setup_intent()&&!this.is_saved_method_selected()&&this.checkout_fields_valid()){if(e.preventDefault(),this.confirmedSetupIntent)return this.on_setup_intent_received(this.confirmedSetupIntent);this.is_payment_element_enabled()?this.elements.submit().then(function(){this.stripe.confirmSetup({elements:this.elements,clientSecret:this.client_secret,confirmParams:function(){var t={return_url:""};return this.is_current_page("checkout")&&(t.payment_method_data={billing_details:this.get_billing_details()}),t}.bind(this)(),redirect:"if_required"}).then(function(t){if(t.error)return this.submit_card_error(t.error);this.confirmedSetupIntent=t.setupIntent,this.on_setup_intent_received(t.setupIntent)}.bind(this))}.bind(this)):this.stripe.confirmCardSetup(this.client_secret,{payment_method:{card:this.is_custom_form()?this.cardNumber:this.card,billing_details:function(){return this.is_current_page("checkout")?this.get_billing_details():t.extend({},this.is_custom_form()?{address:{postal_code:t("#stripe-postal-code").val()}}:{})}.bind(this)()}}).then(function(t){t.error?this.submit_card_error(t.error):(this.confirmedSetupIntent=t.setupIntent,this.on_setup_intent_received(t.setupIntent))}.bind(this))}else this.payment_token_received||this.is_saved_method_selected()||(e.preventDefault(),this.checkout_fields_valid()&&this.elements.submit().then(function(t){this.stripe.createPaymentMethod(this.get_create_payment_method_params()).then(function(t){if(t.error)return this.submit_card_error(t.error);this.is_current_page("order_pay")?(this.set_nonce(t.paymentMethod.id),this.process_order_pay()):this.on_token_received(t.paymentMethod)}.bind(this))}.bind(this)))},i.prototype.checkout_place_order=function(){return this.is_saved_method_selected()||this.payment_token_received?e.CheckoutGateway.prototype.checkout_place_order.apply(this,arguments):(this.place_order.apply(this,arguments),!1)},i.prototype.on_token_received=function(t){this.payment_token_received=!0,t.hasOwnProperty("id")?this.set_nonce(t.id):this.set_nonce(t),this.get_form().trigger("submit")},i.prototype.on_setup_intent_received=function(t){this.payment_token_received=!0,this.set_nonce(t.payment_method),this.set_intent(t.id),this.get_form().trigger("submit")},i.prototype.updated_checkout=function(t,e){if(void 0!==e&&e.fragments&&e.fragments.hasOwnProperty(".sswps-element-options")&&this.is_payment_element_enabled())try{var i=JSON.parse(window.atob(decodeURIComponent(e.fragments[".sswps-element-options"])));this.params.elementOptions.mode!==i.mode&&(this.params.elementOptions.mode=i.mode,this.params.cardFormType="payment",this.elements=this.create_stripe_elements(),this.setup_card())}catch(t){}this.create_card_element(),this.handle_create_account_change(),this.has_gateway_data()&&this.can_create_setup_intent()&&!this.client_secret&&!this.is_payment_element_enabled()&&this.create_setup_intent()},i.prototype.update_checkout=function(){this.clear_card_elements()},i.prototype.show_payment_button=function(){e.CheckoutGateway.prototype.show_place_order.apply(this,arguments)},i.prototype.hide_place_order=function(){},i.prototype.is_custom_form=function(){return"1"===this.params.custom_form},i.prototype.get_postal_code=function(){return this.is_custom_form()&&t("#stripe-postal-code").length>0?t("#stripe-postal-code").val():this.fields.get(this.get_billing_prefix()+"_postcode",null)},i.prototype.card_number_change=function(e){"unknown"===e.brand?t("#sswps-card").removeClass("active"):t("#sswps-card").addClass("active"),t("#sswps-card").attr("src",this.params.cards[e.brand])},i.prototype.on_input_change=function(e){if(e.complete){var i=t("#sswps-cc-custom-form").find(".StripeElement, #stripe-postal-code"),s=[];i.each(function(e,i){s.push("#"+t(i).attr("id"))}.bind(this));var n=this.mappings[e.elementType],a=s.indexOf(n);if(void 0!==s[a+1])if("#stripe-postal-code"===s[a+1])document.getElementById("stripe-postal-code").focus();else for(var o in this.mappings)this.mappings[o]===s[a+1]&&this[o].focus()}},i.prototype.clear_card_elements=function(){for(var t=["cardNumber","cardExpiry","cardCvc"],e=0;e<t.length;e++)this[t[e]]&&this[t[e]].clear()},i.prototype.checkout_error=function(){this.is_gateway_selected()&&(this.payment_token_received=!1),e.CheckoutGateway.prototype.checkout_error.call(this)},i.prototype.get_billing_details=function(){var t=e.BaseGateway.prototype.get_billing_details.call(this);return t.address.postal_code=this.get_postal_code(),t},i.prototype.can_create_setup_intent=function(){return this.is_add_payment_method_page()||this.is_change_payment_method()||this.is_current_page("checkout")&&this.cart_contains_subscription()&&this.has_gateway_data()&&0==this.get_total_price_cents()||this.is_current_page(["checkout","product"])&&"undefined"!=typeof sswps_preorder_exists||this.is_current_page("order_pay")&&"pre_order"in this.get_gateway_data()&&!0===this.get_gateway_data().pre_order||this.is_current_page("product")&&0==this.get_total_price_cents()},i.prototype.submit_card_error=function(i){"bcf"===this.params.notice_location&&(t(".sswps-card-notice").remove(),t(".sswps_cc-new-method-container").append('<div class="sswps-card-notice"></div>')),e.BaseGateway.prototype.submit_error.call(this,i,!0)},i.prototype.container_styles=function(){e.CheckoutGateway.prototype.container_styles.apply(this,arguments),this.is_custom_form()&&t(this.container).find(".payment_box").addClass("custom-form__"+this.params.custom_form_name)},i.prototype.checkout_fields_valid=function(){var t=this.is_valid_checkout();return t||this.submit_error(this.params.messages.terms),t},i.prototype.is_installments_available=function(){var t=this.get_gateway_data();return!!t&&!!t.installments.enabled},i.prototype.update_element_status=function(t){this.elementStatus[t.elementType]=t},i.prototype.is_card_form_complete=function(){return Object.keys(this.elementStatus).filter(function(t){return!!this.elementStatus[t].complete}.bind(this)).length==Object.keys(this.elementStatus).length},i.prototype.on_card_element_change=function(t){this.update_element_status(t),this.is_current_page(["checkout","order_pay"])&&this.is_card_form_complete()&&this.is_installments_available()&&this.initialize_installments()},i.prototype.initialize_installments=function(t){this.installmentTimeoutId&&clearTimeout(this.installmentTimeoutId),this.installmentTimeoutId=setTimeout(function(t){t?(this.show_installment_loader(),this.fetch_installment_plans(t).finally(function(){this.hide_installment_loader()}.bind(this))):this.elements.submit().then(function(){this.stripe.createPaymentMethod(this.get_create_payment_method_params()).then(function(t){t.error?this.hide_installment_loader():(this.show_installment_loader(),this.fetch_installment_plans(t.paymentMethod.id).finally(function(){this.hide_installment_loader()}.bind(this)))}.bind(this)).catch(this.hide_installment_loader.bind(this))}.bind(this))}.bind(this,t),250)},i.prototype.fetch_installment_plans=function(e){return this.fetch_payment_intent(e).then(function(e){e.installments_html&&t(".sswps-installment-container").replaceWith(e.installments_html)}.bind(this)).catch(function(t){return this.submit_card_error(t)}.bind(this)).finally(function(){}.bind(this))},i.prototype.fetch_payment_intent=function(e){return new Promise(function(i,s){var n=this.params.routes.create_payment_intent,a=!1;this.is_current_page("order_pay")&&(n=this.params.routes.order_create_payment_intent,a=!0),t.ajax({url:n,method:"POST",dataType:"json",data:a?{payment_method_id:e,payment_method:this.gateway_id,order_id:this.get_gateway_data().order.id,order_key:this.get_gateway_data().order.key}:t.extend({},this.serialize_fields(),{payment_method_id:e,payment_method:this.gateway_id,page_id:this.get_page()}),beforeSend:this.ajax_before_send.bind(this)}).done(function(t){t.code?s(t):i(t)}.bind(this)).fail(function(t){s()}.bind(this))}.bind(this))},i.prototype.show_installment_loader=function(){t(".sswps-installment-options").addClass("loading-installments"),t('[name="_stripe_installment_plan"] option:selected').eq(0).text(this.params.installments.loading),t(".sswps-installment-loader").show()},i.prototype.hide_installment_loader=function(e){t(".sswps-installment-options").removeClass("loading-installments"),t(".sswps-installment-loader").hide()},i.prototype.maybe_initialize_installments=function(){this.is_installments_available()&&this.is_saved_method_selected()&&this.initialize_installments(this.get_selected_payment_method())},i.prototype.is_payment_element_enabled=function(){return"payment"===this.params.cardFormType},i.prototype.get_element_options=function(){if(this.is_payment_element_enabled()){var e="payment"===this.params.elementOptions.mode?this.get_payment_element_params():{};return t.extend({},this.params.elementOptions,e)}return this.params.elementOptions},i.prototype.get_payment_element_params=function(){if(this.has_gateway_data()){var t={amount:this.get_total_price_cents(),currency:this.get_currency().toLowerCase()};return t.amount<=0&&(t.amount=100),t}return{amount:100,currency:this.params.currency.toLowerCase()}},i.prototype.get_create_payment_method_params=function(){return this.is_payment_element_enabled()?{elements:this.elements,params:{billing_details:this.get_billing_details()}}:{type:"card",card:this.is_custom_form()?this.cardNumber:this.card,billing_details:this.get_billing_details()}},i.prototype.handle_email_change=function(){this.is_payment_element_enabled()&&this.card&&this.card.update({defaultValues:{billingDetails:{email:t("#billing_email").val(),phone:t("#billing_phone").val()}}})},new i}(jQuery,window.sswps);
//# sourceMappingURL=credit-card.js.map